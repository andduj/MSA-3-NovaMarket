@startuml NovaMarket Updated C4 Container Diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

title NovaMarket - Updated Container Diagram (C4 Level 2) - Task 2

Person(customer, "Покупатель", "Пользователь мобильного приложения")
Person(seller, "Продавец", "Продавец товаров на платформе")

System_Boundary(novamarket, "NovaMarket Platform") {
    Container(mobile_app, "Мобильное приложение", "React Native", "Предоставляет интерфейс для покупателей")
    Container(api_gateway, "API Gateway", "NGINX", "Маршрутизация запросов, аутентификация, rate limiting")
    
    Container(catalog_service, "Catalog Service", "Kotlin, Spring Boot", "Управление каталогом товаров, поиск, фильтрация")
    Container(order_service, "Order Service", "Kotlin, Spring Boot", "Управление заказами, корзина, статусы")
    Container(payment_service, "Payment Service", "Kotlin, Spring Boot", "Обработка платежей, интеграция с платежными системами")
    Container(inventory_service, "Inventory Service", "Kotlin, Spring Boot", "Управление остатками товаров, резервирование")
    Container(notification_service, "Notification Service", "Kotlin, Spring Boot", "Отправка уведомлений продавцам и покупателям")
    Container(delivery_service, "Delivery Service", "Kotlin, Spring Boot", "Интеграция с логистическими провайдерами")
    Container(user_service, "User Service", "Kotlin, Spring Boot", "Управление пользователями, аутентификация")
    
    ' Новые сервисы для Task 2
    Container(order_history_service, "Order History Service", "Kotlin, Spring Boot", "Агрегация истории заказов пользователя")
    Container(review_service, "Review Service", "Kotlin, Spring Boot", "Управление отзывами о товарах")
    Container(receipt_service, "Receipt Service", "Kotlin, Spring Boot", "Генерация чеков для заказов")
    
    ContainerDb(catalog_db, "Catalog Database", "PostgreSQL", "Хранение данных о товарах, категориях, отзывах")
    ContainerDb(order_db, "Order Database", "PostgreSQL", "Хранение заказов, корзин, статусов")
    ContainerDb(payment_db, "Payment Database", "PostgreSQL", "Хранение платежных данных, транзакций")
    ContainerDb(inventory_db, "Inventory Database", "PostgreSQL", "Хранение остатков товаров")
    ContainerDb(user_db, "User Database", "PostgreSQL", "Хранение данных пользователей")
    ContainerDb(review_db, "Review Database", "PostgreSQL", "Хранение отзывов пользователей")
    
    ' Event Store для CQRS
    ContainerDb(event_store, "Event Store", "EventStoreDB", "Хранение всех событий домена для Event Sourcing")
    
    Container(kafka, "Event Broker", "Apache Kafka", "Центральный брокер событий для межсервисного взаимодействия")
    
    ' Read Model для CQRS
    ContainerDb(order_history_read_db, "Order History Read DB", "PostgreSQL", "Оптимизированная БД для чтения истории заказов")
}

System_Ext(payment_gateway, "Payment Gateway", "Внешний платежный шлюз")
System_Ext(logistics_provider, "Logistics Provider", "Внешний логистический провайдер")

' Пользовательские взаимодействия
Rel(customer, mobile_app, "Использует", "HTTPS")
Rel(seller, notification_service, "Получает уведомления", "Email/SMS")

' API Gateway взаимодействия
Rel(mobile_app, api_gateway, "API calls", "HTTPS/JSON")
Rel(api_gateway, catalog_service, "Запросы каталога", "HTTP/JSON")
Rel(api_gateway, order_service, "Запросы заказов", "HTTP/JSON")
Rel(api_gateway, user_service, "Аутентификация", "HTTP/JSON")
Rel(api_gateway, order_history_service, "Запросы истории заказов", "HTTP/JSON")
Rel(api_gateway, review_service, "Запросы отзывов", "HTTP/JSON")
Rel(api_gateway, receipt_service, "Запросы чеков", "HTTP/JSON")

' Событийные взаимодействия
Rel(order_service, kafka, "Публикует OrderCreated", "Kafka")
Rel(kafka, inventory_service, "Потребляет OrderCreated", "Kafka")
Rel(kafka, notification_service, "Потребляет OrderCreated", "Kafka")
Rel(kafka, order_history_service, "Потребляет OrderCreated", "Kafka")

Rel(inventory_service, kafka, "Публикует InventoryReserved", "Kafka")
Rel(kafka, order_service, "Потребляет InventoryReserved", "Kafka")

Rel(order_service, kafka, "Публикует OrderReadyForPayment", "Kafka")
Rel(kafka, payment_service, "Потребляет OrderReadyForPayment", "Kafka")

Rel(payment_service, kafka, "Публикует PaymentSucceeded", "Kafka")
Rel(kafka, order_service, "Потребляет PaymentSucceeded", "Kafka")
Rel(kafka, delivery_service, "Потребляет PaymentSucceeded", "Kafka")
Rel(kafka, notification_service, "Потребляет PaymentSucceeded", "Kafka")
Rel(kafka, receipt_service, "Потребляет PaymentSucceeded", "Kafka")

Rel(delivery_service, kafka, "Публикует DeliveryRequested", "Kafka")
Rel(kafka, notification_service, "Потребляет DeliveryRequested", "Kafka")

Rel(delivery_service, kafka, "Публикует OrderStatusUpdated", "Kafka")
Rel(kafka, order_service, "Потребляет OrderStatusUpdated", "Kafka")
Rel(kafka, notification_service, "Потребляет OrderStatusUpdated", "Kafka")
Rel(kafka, order_history_service, "Потребляет OrderStatusUpdated", "Kafka")

Rel(review_service, kafka, "Публикует ReviewCreated", "Kafka")
Rel(kafka, catalog_service, "Потребляет ReviewCreated", "Kafka")

' Event Sourcing
Rel(order_service, event_store, "Сохраняет события", "Event Store API")
Rel(payment_service, event_store, "Сохраняет события", "Event Store API")
Rel(inventory_service, event_store, "Сохраняет события", "Event Store API")

' CQRS Read Model обновления
Rel(order_history_service, order_history_read_db, "Обновляет read model", "SQL")
Rel(order_history_service, order_history_read_db, "Читает агрегированные данные", "SQL")

' Прямые взаимодействия с внешними системами
Rel(payment_service, payment_gateway, "Обработка платежей", "HTTPS/API")
Rel(delivery_service, logistics_provider, "Создание заявок на доставку", "HTTPS/API")

' Базы данных
Rel(catalog_service, catalog_db, "Читает/записывает", "SQL")
Rel(order_service, order_db, "Читает/записывает", "SQL")
Rel(payment_service, payment_db, "Читает/записывает", "SQL")
Rel(inventory_service, inventory_db, "Читает/записывает", "SQL")
Rel(user_service, user_db, "Читает/записывает", "SQL")
Rel(review_service, review_db, "Читает/записывает", "SQL")

@enduml
